<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LeetCode Daily Challenge Tester</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap"
    rel="stylesheet">
  <style>
    :root {
      --bg-primary: #121212;
      --bg-secondary: #1e1e1e;
      --bg-tertiary: #252525;
      --text-primary: #e0e0e0;
      --text-secondary: #a0a0a0;
      --accent-primary: #3182ce;
      --accent-hover: #4299e1;
      --success-bg: #1a382a;
      --success-border: #2d6a4f;
      --success-text: #4ade80;
      --error-bg: #3b1a1a;
      --error-border: #6b2121;
      --error-text: #f87171;
      --pending-bg: #382a1a;
      --pending-border: #6a582d;
      --pending-text: #f59e0b;
      --border-radius: 8px;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      max-width: 900px;
      margin: 0 auto;
      padding: 2rem;
      transition: all 0.3s ease;
      min-height: 100vh;
    }

    .container {
      background-color: var(--bg-secondary);
      padding: 2rem;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      margin-bottom: 2rem;
    }

    h1,
    h2,
    h3 {
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--text-primary);
    }

    h1 {
      font-size: 2rem;
      text-align: center;
      margin-bottom: 2rem;
      background: linear-gradient(90deg, #3182ce, #00b5d8);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    button {
      background-color: var(--accent-primary);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-weight: 500;
      font-family: 'Inter', sans-serif;
      transition: all 0.2s ease;
      margin: 0.5rem 0;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    button:hover {
      background-color: var(--accent-hover);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    button:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    textarea {
      width: 100%;
      height: 300px;
      margin: 1rem 0;
      padding: 1rem;
      background-color: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid #333;
      border-radius: var(--border-radius);
      font-family: 'JetBrains Mono', monospace;
      font-size: 14px;
      resize: vertical;
      transition: all 0.2s ease;
    }

    textarea:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 2px rgba(49, 130, 206, 0.3);
    }

    #result,
    #submissionStatus,
    #problemResult,
    #problemSubmissionStatus {
      margin-top: 1.5rem;
      padding: 1.5rem;
      background-color: var(--bg-tertiary);
      border: 1px solid #333;
      border-radius: var(--border-radius);
      white-space: pre-wrap;
      overflow-x: auto;
    }

    .success {
      background-color: var(--success-bg);
      border: 1px solid var(--success-border);
      padding: 1.5rem;
      border-radius: var(--border-radius);
    }

    .success h3 {
      color: var(--success-text);
      margin-top: 0;
      font-weight: 600;
    }

    .error {
      background-color: var(--error-bg);
      border: 1px solid var(--error-border);
      padding: 1.5rem;
      border-radius: var(--border-radius);
    }

    .error h3 {
      color: var(--error-text);
      margin-top: 0;
      font-weight: 600;
    }

    .pending {
      background-color: var(--pending-bg);
      border: 1px solid var(--pending-border);
      padding: 1.5rem;
      border-radius: var(--border-radius);
    }

    .pending h3 {
      color: var(--pending-text);
      margin-top: 0;
      font-weight: 600;
    }

    details {
      margin-top: 1.5rem;
    }

    summary {
      cursor: pointer;
      color: var(--accent-primary);
      padding: 0.5rem 0;
      font-weight: 500;
    }

    details pre {
      background-color: var(--bg-primary);
      padding: 1rem;
      border-radius: var(--border-radius);
      overflow: auto;
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      margin-top: 0.5rem;
    }

    .challenge-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding: 0.75rem 1rem;
      background-color: var(--bg-tertiary);
      border-radius: var(--border-radius);
    }

    .difficulty {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 4px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .difficulty.easy {
      background-color: rgba(34, 197, 94, 0.2);
      color: #4ade80;
    }

    .difficulty.medium {
      background-color: rgba(245, 158, 11, 0.2);
      color: #f59e0b;
    }

    .difficulty.hard {
      background-color: rgba(239, 68, 68, 0.2);
      color: #f87171;
    }

    a {
      color: var(--accent-primary);
      text-decoration: none;
      transition: color 0.2s ease;
    }

    a:hover {
      color: var(--accent-hover);
      text-decoration: underline;
    }

    .question-description {
      background-color: var(--bg-tertiary);
      padding: 1.5rem;
      border-radius: var(--border-radius);
      margin-top: 1rem;
      line-height: 1.7;
    }

    .question-description p,
    .question-description ul,
    .question-description ol {
      margin-bottom: 1rem;
    }

    .question-description code {
      font-family: 'JetBrains Mono', monospace;
      background-color: var(--bg-primary);
      padding: 0.2rem 0.4rem;
      border-radius: 4px;
      font-size: 0.9em;
    }

    .question-description pre {
      background-color: var(--bg-primary);
      padding: 1rem;
      border-radius: var(--border-radius);
      overflow: auto;
      margin: 1rem 0;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }

    .logo {
      font-size: 1.5rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .logo-icon {
      color: var(--accent-primary);
    }

    /* Loading spinner */
    .spinner {
      display: inline-block;
      width: 2rem;
      height: 2rem;
      border-radius: 50%;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top-color: var(--accent-primary);
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      padding: 2rem;
    }

    /* Code editor enhancements */
    .code-editor-container {
      position: relative;
      margin: 1rem 0;
    }

    .code-editor-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: var(--bg-primary);
      padding: 0.75rem 1rem;
      border-top-left-radius: var(--border-radius);
      border-top-right-radius: var(--border-radius);
      border: 1px solid #333;
      border-bottom: none;
    }

    .code-language {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    textarea {
      margin-top: 0;
      border-top-left-radius: 0;
      border-top-right-radius: 0;
    }

    /* Footer styling */
    .footer {
      text-align: center;
      margin-top: 2rem;
      padding-top: 1rem;
      color: var(--text-secondary);
      font-size: 0.85rem;
      border-top: 1px solid #333;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      body {
        padding: 1rem;
      }

      .container {
        padding: 1.5rem;
      }
    }

    /* Button enhancements */
    .btn-group {
      display: flex;
      gap: 1rem;
      margin: 1rem 0;
    }

    .btn-primary {
      background-color: var(--accent-primary);
    }

    .btn-secondary {
      background-color: transparent;
      border: 1px solid var(--accent-primary);
      color: var(--accent-primary);
    }

    .btn-secondary:hover {
      background-color: rgba(49, 130, 206, 0.1);
    }

    /* Privacy note */
    .privacy-note {
      font-size: 0.8rem;
      margin-top: 0.5rem;
      color: var(--text-secondary);
    }

    /* Login status */
    #loginStatus {
      margin-bottom: 2rem;
    }

    /* Cookie warning */
    .cookie-warning {
      background-color: var(--bg-tertiary);
      border-left: 4px solid var(--pending-text);
      padding: 1rem;
      margin: 1rem 0;
      font-size: 0.9rem;
    }

    /* Authentication section */
    .auth-actions {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
    }

    /* Tab navigation */
    .tab-navigation {
      display: flex;
      border-bottom: 1px solid #333;
      margin-bottom: 1.5rem;
    }

    .tab-button {
      padding: 0.75rem 1.5rem;
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      margin: 0;
      box-shadow: none;
    }

    .tab-button:hover {
      color: var(--text-primary);
      background-color: rgba(255, 255, 255, 0.05);
      transform: none;
      box-shadow: none;
    }

    .tab-button.active {
      color: var(--accent-primary);
      border-bottom: 2px solid var(--accent-primary);
      font-weight: 600;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Form input styling */
    input[type="text"] {
      width: 100%;
      padding: 0.75rem 1rem;
      background-color: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid #333;
      border-radius: var(--border-radius);
      font-family: 'Inter', sans-serif;
      margin-bottom: 1rem;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 2px rgba(49, 130, 206, 0.3);
    }

    label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--text-primary);
      font-weight: 500;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <div class="logo">
        <span class="logo-icon">âš¡</span> LeetCode Daily Challenge Tester
      </div>
    </div>

    <div id="loginStatus"></div>

    <div id="appControls" style="display: none;">
      <div class="tab-navigation">
        <button class="tab-button active" onclick="switchTab('daily-challenge')">Daily Challenge</button>
        <button class="tab-button" onclick="switchTab('any-problem')">Any LeetCode Problem</button>
      </div>

      <div id="daily-challenge" class="tab-content active">
        <div class="btn-group">
          <button class="btn-primary" onclick="getDailyChallenge()">Get Today's Challenge</button>
          <button class="btn-secondary" onclick="clearCredentials()">Reset Credentials</button>
        </div>

        <div id="result"></div>

        <h2>Submit Your Solution</h2>
        <div class="code-editor-container">
          <div class="code-editor-header">
            <span class="code-language">C++</span>
          </div>
          <textarea id="codeInput" placeholder="Paste your C++ solution here..."></textarea>
        </div>

        <button class="btn-primary" onclick="submitSolution()">Submit Solution</button>
        <div id="submissionStatus"></div>
      </div>

      <div id="any-problem" class="tab-content">
        <h2>Submit Solution for Any LeetCode Problem</h2>
        <p>Enter the problem slug (e.g., "two-sum" or "3sum") to fetch the problem details and submit your solution.</p>

        <div style="margin: 1.5rem 0;">
          <label for="problemSlug">Problem Slug or Name:</label>
          <input type="text" id="problemSlug" placeholder="e.g., two-sum, 3sum, etc.">
          <button class="btn-primary" onclick="getProblemBySlug()">Get Problem</button>
        </div>

        <div id="problemResult"></div>

        <div id="problemSubmitSection" style="display: none;">
          <h3>Submit Your Solution</h3>
          <div class="code-editor-container">
            <div class="code-editor-header">
              <span class="code-language">C++</span>
            </div>
            <textarea id="problemCodeInput" placeholder="Paste your C++ solution here..."></textarea>
          </div>

          <button class="btn-primary" onclick="submitProblemSolution()">Submit Solution</button>
          <div id="problemSubmissionStatus"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="footer">
    <p>LeetCode Daily Challenge Tester Â© 2023</p>
    <p class="privacy-note">Your LeetCode credentials are stored only in your browser and are never sent to our servers.
    </p>
  </div>

  <script>
    let questionId = '';
    let problemQuestionId = '';
    let problemTitleSlug = ''; // Store the title slug for problem submissions
    let userHeaders = null;

    // Function to get LeetCode headers dynamically from the user's browser
    async function getLeetCodeHeaders() {
      console.log('Starting getLeetCodeHeaders function');

      // Check if we already have headers stored in localStorage
      const storedHeaders = localStorage.getItem('leetcode_headers');
      if (storedHeaders) {
        try {
          console.log('Found stored headers in localStorage');
          return JSON.parse(storedHeaders);
        } catch (e) {
          console.error('Failed to parse stored headers:', e);
        }
      }

      try {
        // Log browser information
        const browserInfo = {
          userAgent: navigator.userAgent,
          cookiesEnabled: navigator.cookieEnabled,
          browser: getBrowserInfo()
        };
        console.log('Browser info:', browserInfo);

        // If Firefox, suggest manual method immediately since it has stricter CORS policies
        if (browserInfo.browser === 'Firefox') {
          console.log('Firefox detected - CORS issues likely. Suggesting manual method...');
          throw new Error('Firefox detected. Due to strict security settings, please use the manual authentication method.');
        }

        // Check if cookies are enabled
        if (!navigator.cookieEnabled) {
          console.error('Cookies are disabled in browser');
          throw new Error('Cookies are disabled in your browser. Please enable cookies to use this application.');
        }

        console.log('Current document.cookie length:', document.cookie.length);
        console.log('Cookie sample (first 50 chars):', document.cookie.substring(0, 50));

        // Try direct cookie check first
        const csrfFromDoc = getCookie('csrftoken');
        if (csrfFromDoc) {
          console.log('Found CSRF token directly from document.cookie:', csrfFromDoc.substring(0, 5) + '...');
        } else {
          console.log('No CSRF token found in document.cookie');
        }

        // Make a test request to LeetCode to get the cookies and CSRF token
        console.log('Making test request to LeetCode...');

        try {
          const response = await fetch('https://leetcode.com/graphql/', {
            method: 'POST',
            credentials: 'include', // Important to include cookies
            headers: {
              'Content-Type': 'application/json',
              'Origin': 'https://leetcode.com',
              'Referer': 'https://leetcode.com/'
            },
            body: JSON.stringify({
              query: `query getUserProfile { userStatus { userId username isSignedIn } }`
            })
          });

          console.log('LeetCode test request completed, status:', response.status);
          const responseData = await response.json();
          console.log('Response data:', JSON.stringify(responseData).substring(0, 100) + '...');

          // Check if user is signed in based on the response
          const isSignedIn = responseData?.data?.userStatus?.isSignedIn;
          console.log('User signed in according to LeetCode API:', isSignedIn);

          if (!isSignedIn) {
            console.log('User not signed in according to LeetCode API');
          }
        } catch (fetchError) {
          console.error('Fetch to LeetCode failed, likely a CORS issue:', fetchError);

          // If fetch failed with a CORS or network error, throw specific error to guide user
          if (fetchError.message &&
            (fetchError.message.includes('CORS') ||
              fetchError.message.includes('NetworkError') ||
              fetchError.message.includes('Failed to fetch'))) {
            throw new Error('Browser security settings are preventing access to LeetCode. Please use the manual authentication method.');
          }

          // Otherwise rethrow the original error
          throw fetchError;
        }

        // After fetch, check cookie again (might be updated)
        console.log('Document cookie after fetch, length:', document.cookie.length);
        const cookies = document.cookie;
        console.log('Cookie sample after fetch (first 50 chars):', cookies.substring(0, 50));

        // Extract CSRF token
        const csrfToken = getCookie('csrftoken');
        console.log('CSRF token after fetch:', csrfToken ? (csrfToken.substring(0, 8) + '...') : 'Not found');

        if (!csrfToken) {
          // Alternative ways to try to access the cookie in different browsers
          console.log('CSRF token not found in standard way, trying alternatives...');

          // Try to manually access the cookie for LeetCode domain
          const allCookies = document.cookie.split(';');
          console.log('All cookies count:', allCookies.length);

          for (const cookie of allCookies) {
            console.log('Cookie entry:', cookie.trim().substring(0, 20) + '...');
          }

          // If still no CSRF token, throw error
          if (!csrfToken) {
            throw new Error('CSRF Token not found. This may be due to browser security restrictions. Please use the manual authentication method.');
          }
        }

        const headers = {
          'Content-Type': 'application/json',
          'Cookie': cookies,
          'Referer': 'https://leetcode.com/',
          'User-Agent': navigator.userAgent,
          'x-csrftoken': csrfToken,
          'Origin': 'https://leetcode.com'
        };

        console.log('Creating headers object with:', {
          'Content-Type': 'application/json',
          'Cookie': cookies ? 'Present, length: ' + cookies.length : 'Missing',
          'x-csrftoken': csrfToken ? 'Present: ' + csrfToken.substring(0, 8) + '...' : 'Missing',
          'Origin': 'https://leetcode.com'
        });

        // Store headers in localStorage for future use
        localStorage.setItem('leetcode_headers', JSON.stringify(headers));
        console.log('Headers stored in localStorage');

        return headers;
      } catch (error) {
        console.error('Error fetching LeetCode headers:', error);
        console.error('Error details:', {
          message: error.message,
          name: error.name,
          stack: error.stack
        });
        throw error;
      }
    }

    // Helper function to get browser information
    function getBrowserInfo() {
      const userAgent = navigator.userAgent;
      let browserName;

      if (userAgent.match(/chrome|chromium|crios/i)) {
        browserName = "Chrome";
      } else if (userAgent.match(/firefox|fxios/i)) {
        browserName = "Firefox";
      } else if (userAgent.match(/safari/i)) {
        browserName = "Safari";
      } else if (userAgent.match(/edg/i)) {
        browserName = "Edge";
      } else if (userAgent.match(/opr\//i)) {
        browserName = "Opera";
      } else {
        browserName = "Unknown";
      }

      return browserName;
    }

    // Helper function to get a specific cookie value by name
    function getCookie(name) {
      console.log(`Attempting to get cookie: ${name}`);
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      console.log(`Cookie parts for ${name}:`, parts.length - 1);
      if (parts.length === 2) {
        const cookieValue = parts.pop().split(';').shift();
        console.log(`Found cookie value for ${name}, length:`, cookieValue.length);
        return cookieValue;
      }
      console.log(`Cookie ${name} not found`);
      return null;
    }

    // Function to extract CSRF token from cookies
    function getCsrfToken() {
      return getCookie('csrftoken');
    }

    // Initialize headers when page loads
    async function initializeApp() {
      try {
        const loginStatusEl = document.getElementById('loginStatus');
        loginStatusEl.innerHTML = `
          <div class="pending">
            <div class="spinner"></div>
            <p>Checking LeetCode login status...</p>
          </div>
        `;

        // First check if third-party cookies might be blocked
        console.log('Checking cookie and browser compatibility...');
        const browserType = getBrowserInfo();
        console.log('Browser detected:', browserType);

        // For Firefox, recommend manual authentication immediately
        if (browserType === 'Firefox') {
          console.log('Firefox detected - showing Firefox-specific instructions');
          loginStatusEl.innerHTML = `
            <div class="cookie-warning">
              <h3>Firefox Detected</h3>
              <p>Firefox has stricter security settings that prevent direct access to LeetCode cookies.</p>
              <p>Please use the manual authentication method instead:</p>
              
              <ol>
                <li>Make sure you're <a href="https://leetcode.com/accounts/login/" target="_blank">logged in to LeetCode</a> in this browser</li>
                <li>Press F12 or right-click and select "Inspect" to open Developer Tools</li>
                <li>Go to the "Storage" tab (you might need to click the >> button to find it)</li>
                <li>In the left sidebar, expand "Cookies" and click on "https://leetcode.com"</li>
                <li>Find the "csrftoken" and "LEETCODE_SESSION" cookies</li>
                <li>Copy these values for manual entry below</li>
              </ol>
              
              <div class="auth-actions">
                <button onclick="manualAuthenticationSetup()" class="btn-primary">Enter Credentials Manually</button>
                <button onclick="attemptAuthentication()" class="btn-secondary">Try Automatic Authentication</button>
              </div>
            </div>
          `;
          document.getElementById('appControls').style.display = 'none';
          return;
        }

        if (!navigator.cookieEnabled) {
          console.error('Cookies are disabled in browser');
          loginStatusEl.innerHTML = `
            <div class="error">
              <h3>Cookies Disabled</h3>
              <p>Cookies appear to be disabled in your browser. Please enable cookies to use this application.</p>
            </div>
          `;
          document.getElementById('appControls').style.display = 'none';
          return;
        }

        try {
          console.log('Attempting to get LeetCode headers...');
          userHeaders = await getLeetCodeHeaders();
          console.log('Successfully got headers:', userHeaders ? 'yes' : 'no');

          const csrfToken = userHeaders['x-csrftoken'];
          if (csrfToken) {
            console.log('CSRF Token found in headers');
            loginStatusEl.innerHTML = `
              <div class="success">
                <h3>LeetCode Authentication Ready</h3>
                <p>Your LeetCode credentials have been detected. You can now use the app.</p>
                <p><strong>CSRF Token:</strong> ${csrfToken.substring(0, 8)}...${csrfToken.substring(csrfToken.length - 8)}</p>
              </div>
            `;
            document.getElementById('appControls').style.display = 'block';
          } else {
            console.error('No CSRF token found in headers');
            throw new Error('CSRF token not found');
          }
        } catch (authError) {
          console.error('Auth error:', authError);
          console.error('Browser:', getBrowserInfo());

          // Check if error message indicates CORS issues
          const isCorsError = authError.message && (
            authError.message.includes('CORS') ||
            authError.message.includes('NetworkError') ||
            authError.message.includes('Failed to fetch') ||
            authError.message.includes('browser security')
          );

          // Show more specific troubleshooting instructions based on browser
          let browserSpecificInstructions = '';

          switch (getBrowserInfo()) {
            case 'Chrome':
              browserSpecificInstructions = `
                <p><strong>Chrome Troubleshooting:</strong></p>
                <ol>
                  <li>Go to chrome://settings/cookies</li>
                  <li>Ensure "Block third-party cookies" is not enabled</li>
                  <li>Add this site to the "Sites that can always use cookies" list</li>
                </ol>
              `;
              break;
            case 'Firefox':
              browserSpecificInstructions = `
                <p><strong>Firefox Troubleshooting:</strong></p>
                <ol>
                  <li>Go to about:preferences#privacy</li>
                  <li>Under "Enhanced Tracking Protection" choose "Custom"</li>
                  <li>Make sure "Cookies" is not set to "All cross-site cookies"</li>
                  <li>For Firefox, using the manual method is strongly recommended</li>
                </ol>
              `;
              break;
            case 'Edge':
              browserSpecificInstructions = `
                <p><strong>Edge Troubleshooting:</strong></p>
                <ol>
                  <li>Go to edge://settings/cookies</li>
                  <li>Ensure "Block third-party cookies" is disabled</li>
                  <li>Add both this site and leetcode.com to "Allow" list</li>
                </ol>
              `;
              break;
            default:
              browserSpecificInstructions = `
                <p>Please check your browser settings to allow third-party cookies for this site and leetcode.com</p>
              `;
          }

          // For CORS errors, recommend manual method strongly
          if (isCorsError) {
            loginStatusEl.innerHTML = `
              <div class="error">
                <h3>Browser Security Restriction</h3>
                <p>Your browser's security settings are preventing direct access to LeetCode. This is common with Firefox and other browsers with strict CORS policies.</p>
                
                <div class="cookie-warning">
                  <strong>Recommended Solution:</strong> Use the manual authentication method below.
                  
                  ${browserSpecificInstructions}
                </div>
                
                <div class="auth-actions">
                  <button onclick="manualAuthenticationSetup()" class="btn-primary">Enter Credentials Manually</button>
                  <button onclick="attemptAuthentication()" class="btn-secondary">Try Automatic Authentication</button>
                  <a href="https://leetcode.com/accounts/login/" target="_blank" class="btn-secondary">Log in to LeetCode</a>
                </div>
              </div>
            `;
          } else {
            loginStatusEl.innerHTML = `
              <div class="error">
                <h3>Authentication Required</h3>
                <p>We couldn't detect your LeetCode login. Please ensure you're logged into LeetCode in this browser.</p>
                
                <div class="cookie-warning">
                  <strong>Important:</strong> This app requires third-party cookies to be enabled to access your LeetCode account.
                  If you're having issues, please check your browser settings to allow third-party cookies for this site.
                  
                  ${browserSpecificInstructions}
                </div>
                
                <div class="auth-actions">
                  <a href="https://leetcode.com/accounts/login/" target="_blank" class="btn-primary">Log in to LeetCode</a>
                  <button onclick="attemptAuthentication()" class="btn-secondary">I'm already logged in</button>
                  <button onclick="manualAuthenticationSetup()" class="btn-secondary">Enter Credentials Manually</button>
                </div>
              </div>
            `;
          }

          document.getElementById('appControls').style.display = 'none';
        }
      } catch (error) {
        console.error('Initialization error:', error);
        document.getElementById('loginStatus').innerHTML = `
          <div class="error">
            <h3>Authentication Failed</h3>
            <p>${error.message}</p>
            <p>Please make sure you're logged into LeetCode in this browser, then refresh this page.</p>
            
            <div class="cookie-warning">
              <strong>Important:</strong> This app requires third-party cookies to be enabled to access your LeetCode account.
              If you're having issues, please check your browser settings to allow third-party cookies for this site.
            </div>
            
            <div class="auth-actions">
              <a href="https://leetcode.com/accounts/login/" target="_blank" class="btn-primary">Log in to LeetCode</a>
              <button onclick="location.reload()" class="btn-secondary">Refresh Page</button>
              <button onclick="manualAuthenticationSetup()" class="btn-secondary">Enter Credentials Manually</button>
            </div>
          </div>
        `;
        document.getElementById('appControls').style.display = 'none';
      }
    }

    // Function for manual authentication attempt
    async function attemptAuthentication() {
      const loginStatusEl = document.getElementById('loginStatus');
      loginStatusEl.innerHTML = `
        <div class="pending">
          <div class="spinner"></div>
          <p>Attempting to authenticate with LeetCode...</p>
        </div>
      `;

      try {
        console.log('Starting authentication attempt...');
        const browser = getBrowserInfo();

        // For Firefox, direct CORS requests usually fail, so focus on server check
        const isFirefox = browser === 'Firefox';

        if (isFirefox) {
          console.log('Firefox detected, skipping direct request to LeetCode due to CORS issues');
        } else {
          // For other browsers, try direct request first
          console.log('Trying direct fetch to LeetCode');
          try {
            const directResponse = await fetch('https://leetcode.com/graphql/', {
              method: 'POST',
              credentials: 'include',
              headers: {
                'Content-Type': 'application/json',
                'Origin': window.location.origin,
                'Referer': window.location.href,
              },
              body: JSON.stringify({
                query: `query getUserProfile { userStatus { userId username isSignedIn } }`
              }),
              mode: 'cors'
            });

            console.log('Direct fetch response status:', directResponse.status);
            const data = await directResponse.json();
            console.log('Direct fetch response data:', data);

            // Check if the user is signed in
            const isSignedIn = data?.data?.userStatus?.isSignedIn;
            if (isSignedIn) {
              console.log('User is signed in according to direct fetch!');
            } else {
              console.log('User is not signed in according to direct fetch');
            }
          } catch (directFetchError) {
            console.error('Direct fetch failed:', directFetchError);
          }
        }

        // Now try the server-side authentication, which is more reliable across browsers
        console.log('Trying server-side authentication check...');
        try {
          // First make a request to leetcode.com to set any cookies
          try {
            const pingResponse = await fetch('https://leetcode.com', {
              method: 'GET',
              credentials: 'include',
              mode: 'no-cors' // This allows the request to succeed even with CORS restrictions
            });
            console.log('Pinged LeetCode to set cookies');
          } catch (pingError) {
            console.log('Ping to LeetCode completed (no-cors mode)');
          }

          // Now try to get available cookies
          const availableCookies = document.cookie;
          console.log('Available cookies after ping:', availableCookies ? 'present' : 'none');

          // Forward any cookies we have to our server
          const serverCheckResponse = await fetch('http://localhost:5000/api/leetcode/auth-check', {
            method: 'GET',
            credentials: 'include',
            headers: {
              'Cookie': availableCookies
            }
          });

          console.log('Server auth check response status:', serverCheckResponse.status);
          if (serverCheckResponse.ok) {
            const authData = await serverCheckResponse.json();
            console.log('Server auth check response:', authData);

            if (authData.isAuthenticated) {
              console.log('Server confirmed user is authenticated with LeetCode!');
              console.log('Username:', authData.username);

              // If the server provided any cookies, use them
              if (authData.cookies && authData.cookies.csrftoken) {
                console.log('Server provided CSRF token:', authData.cookies.csrftoken.substring(0, 8) + '...');

                // Create headers from the server response
                const headers = {
                  'Content-Type': 'application/json',
                  'Cookie': createCookieString(authData.cookies),
                  'Referer': 'https://leetcode.com/',
                  'User-Agent': navigator.userAgent,
                  'x-csrftoken': authData.cookies.csrftoken,
                  'Origin': 'https://leetcode.com'
                };

                // Store headers in localStorage
                localStorage.setItem('leetcode_headers', JSON.stringify(headers));

                // Update global headers
                userHeaders = headers;

                loginStatusEl.innerHTML = `
                  <div class="success">
                    <h3>Authentication Successful!</h3>
                    <p>User: ${authData.username}</p>
                    <p>Your LeetCode credentials have been detected through our server.</p>
                    <p><strong>CSRF Token:</strong> ${authData.cookies.csrftoken.substring(0, 8)}...</p>
                  </div>
                `;
                document.getElementById('appControls').style.display = 'block';
                return;
              }
            } else {
              console.log('Server says user is not authenticated with LeetCode');

              if (isFirefox) {
                // For Firefox, suggest manual method since server check failed
                loginStatusEl.innerHTML = `
                  <div class="error">
                    <h3>Authentication Failed</h3>
                    <p>Firefox security restrictions prevent automatic authentication.</p>
                    <p><strong>Please use the manual method instead:</strong></p>
                    
                    <div class="auth-actions">
                      <button onclick="manualAuthenticationSetup()" class="btn-primary">Enter Credentials Manually</button>
                      <a href="https://leetcode.com/accounts/login/" target="_blank" class="btn-secondary">Log in to LeetCode</a>
                    </div>
                  </div>
                `;
                document.getElementById('appControls').style.display = 'none';
                return;
              }
            }
          }
        } catch (serverCheckError) {
          console.error('Server auth check failed:', serverCheckError);
        }

        // If we get here, try opening LeetCode and then checking again
        // Open LeetCode in a new tab to try to set cookies
        const leetCodeTab = window.open('https://leetcode.com', '_blank');
        if (leetCodeTab) {
          console.log('Opened LeetCode in new tab');
          leetCodeTab.focus();
        } else {
          console.warn('Failed to open LeetCode tab - popup might be blocked');
        }

        // Give the user time to interact with LeetCode if needed
        console.log('Waiting for some time before trying to get headers again...');
        setTimeout(async () => {
          try {
            console.log('Attempting to get headers after waiting...');
            userHeaders = await getLeetCodeHeaders();

            if (userHeaders && userHeaders['x-csrftoken']) {
              const csrfToken = userHeaders['x-csrftoken'];
              console.log('Successfully obtained CSRF token:', csrfToken.substring(0, 8) + '...');

              loginStatusEl.innerHTML = `
                <div class="success">
                  <h3>Authentication Successful!</h3>
                  <p>Your LeetCode credentials have been detected. You can now use the app.</p>
                  <p><strong>CSRF Token:</strong> ${csrfToken.substring(0, 8)}...${csrfToken.substring(csrfToken.length - 8)}</p>
                </div>
              `;
              document.getElementById('appControls').style.display = 'block';
            } else {
              console.error('Failed to get CSRF token after waiting');
              throw new Error('Could not obtain CSRF token');
            }
          } catch (error) {
            console.error('Authentication retry failed:', error);

            const browser = getBrowserInfo();
            console.log('Browser for error message:', browser);

            // For Firefox, strongly recommend manual method
            if (browser === 'Firefox') {
              loginStatusEl.innerHTML = `
                <div class="error">
                  <h3>Firefox Authentication Failed</h3>
                  <p>Firefox's security model prevents automatic cookie access.</p>
                  <p><strong>Please use the manual method instead:</strong></p>
                  
                  <div class="auth-actions">
                    <button onclick="manualAuthenticationSetup()" class="btn-primary">Enter Credentials Manually</button>
                    <a href="https://leetcode.com/accounts/login/" target="_blank" class="btn-secondary">Log in to LeetCode</a>
                  </div>
                </div>
              `;
              return;
            }

            // Provide tailored instructions based on browser
            let browserTips = '';
            switch (browser) {
              case 'Edge':
                browserTips = `
                  <p><strong>Edge-specific tips:</strong></p>
                  <ol>
                    <li>Go to edge://settings/content/cookies</li>
                    <li>Ensure "Block third-party cookies" is turned OFF</li>
                    <li>Add this site to the "Allow" list</li>
                    <li>Try using the "Enter Credentials Manually" option below</li>
                  </ol>
                `;
                break;
              case 'Chrome':
                browserTips = `
                  <p><strong>Chrome-specific tips:</strong></p>
                  <ol>
                    <li>Go to chrome://settings/cookies</li>
                    <li>Make sure "Block third-party cookies" is OFF</li>
                    <li>Check if you have any extensions that might be blocking cookies</li>
                    <li>Try using Incognito mode (with cookies allowed)</li>
                  </ol>
                `;
                break;
              default:
                browserTips = `
                  <p>You're using ${browser}, which may have strict cookie policies. Try using the "Enter Credentials Manually" option below.</p>
                `;
            }

            loginStatusEl.innerHTML = `
              <div class="error">
                <h3>Authentication Failed</h3>
                <p>${error.message}</p>
                <p>Try these steps:</p>
                <ol>
                  <li>Make sure you're logged in to LeetCode in this browser</li>
                  <li>Check that third-party cookies are enabled in your browser</li>
                  <li>Use the "Enter Credentials Manually" option below</li>
                </ol>
                
                ${browserTips}
                
                <div class="auth-actions">
                  <button onclick="attemptAuthentication()" class="btn-primary">Try Again</button>
                  <button onclick="manualAuthenticationSetup()" class="btn-secondary">Enter Credentials Manually</button>
                </div>
              </div>
            `;
          }
        }, 3000);
      } catch (error) {
        console.error('Authentication attempt failed:', error);
        loginStatusEl.innerHTML = `
          <div class="error">
            <h3>Authentication Failed</h3>
            <p>${error.message}</p>
            <div class="auth-actions">
              <button onclick="attemptAuthentication()" class="btn-primary">Try Again</button>
              <button onclick="manualAuthenticationSetup()" class="btn-secondary">Enter Credentials Manually</button>
            </div>
          </div>
        `;
      }
    }

    // Helper function to create a cookie string from cookie object
    function createCookieString(cookies) {
      if (!cookies) return '';
      return Object.entries(cookies)
        .map(([name, value]) => `${name}=${value}`)
        .join('; ');
    }

    // Function to create a manual authentication form with enhanced instructions for Firefox
    function manualAuthenticationSetup() {
      const loginStatusEl = document.getElementById('loginStatus');
      const browserType = getBrowserInfo();

      // Different instructions based on browser
      let browserInstructions = '';
      if (browserType === 'Firefox') {
        browserInstructions = `
          <p><strong>Firefox Instructions:</strong></p>
          <ol>
            <li>Make sure you're logged in to <a href="https://leetcode.com" target="_blank">LeetCode</a> (open this link and verify you're logged in)</li>
            <li>Press F12 or right-click and select "Inspect" to open Developer Tools</li>
            <li>Go to the "Storage" tab (you might need to click the >> button to find it)</li>
            <li>In the left sidebar, expand "Cookies" and click on "https://leetcode.com"</li>
            <li>Find <strong>"csrftoken"</strong> in the table, click on its value and press Ctrl+C to copy it</li>
            <li>Find <strong>"LEETCODE_SESSION"</strong> in the table, click on its value and press Ctrl+C to copy it</li>
          </ol>
          <p><strong>ðŸ’¡ TIP:</strong> You can also go to LeetCode.com, open the console (F12 > Console) and try these commands:</p>
          <pre style="background: #333; padding: 10px; margin: 10px 0; border-radius: 4px; overflow-x: auto;">
// Run this to see all cookies
document.cookie.split(';').forEach(c => console.log(c.trim()));

// Or use this to try to find specific cookies
const getCookie = name => {
  const value = \`; \${document.cookie}\`;
  const parts = value.split(\`; \${name}=\`);
  if (parts.length === 2) return parts.pop().split(';').shift();
  return null;
}
console.log('CSRF:', getCookie('csrftoken'));
console.log('Session:', getCookie('LEETCODE_SESSION'));</pre>
        `;
      } else if (browserType === 'Chrome' || browserType === 'Edge') {
        browserInstructions = `
          <p><strong>${browserType} Instructions:</strong></p>
          <ol>
            <li>Make sure you're logged in to <a href="https://leetcode.com" target="_blank">LeetCode</a> (open this link and verify you're logged in)</li>
            <li>Press F12 or right-click and select "Inspect" to open Developer Tools</li>
            <li>Go to the "Application" tab</li>
            <li>In the left sidebar, expand "Cookies" and click on "https://leetcode.com"</li>
            <li>Find and copy the values for "csrftoken" and "LEETCODE_SESSION"</li>
          </ol>
          <p><strong>ðŸ’¡ TIP:</strong> You can also go to LeetCode.com, open the console (F12 > Console) and try this command:</p>
          <pre style="background: #333; padding: 10px; margin: 10px 0; border-radius: 4px; overflow-x: auto;">
console.log('CSRF:', document.cookie.split(';').find(c => c.trim().startsWith('csrftoken=')));
console.log('Session:', document.cookie.split(';').find(c => c.trim().startsWith('LEETCODE_SESSION=')));</pre>
        `;
      } else {
        browserInstructions = `
          <p><strong>Browser Instructions:</strong></p>
          <ol>
            <li>Make sure you're logged in to <a href="https://leetcode.com" target="_blank">LeetCode</a> (open this link and verify you're logged in)</li>
            <li>Open Developer Tools (usually F12 or right-click and select "Inspect")</li>
            <li>Find the Storage or Application tab</li>
            <li>Look for Cookies and then https://leetcode.com</li>
            <li>Copy the values for "csrftoken" and "LEETCODE_SESSION"</li>
          </ol>
        `;
      }

      loginStatusEl.innerHTML = `
        <div class="container">
          <h3>Manual Authentication Setup</h3>
          <p>If automatic authentication isn't working, you can manually enter your LeetCode cookies below:</p>
          
          <div class="cookie-warning">
            <strong>Instructions:</strong>
            ${browserInstructions}
          </div>
          
          <div style="text-align: center; margin: 20px 0;">
            <button onclick="fetchCookiesFromServer()" class="btn-primary" style="background-color: #4caf50;">
              <span style="display: inline-block; margin-right: 5px;">ðŸš€</span> Try Automatic Cookie Fetch
            </button>
            <p style="font-size: 0.8rem; margin-top: 5px;">Our server will try to fetch LeetCode cookies for you</p>
          </div>
          
          <div style="margin: 20px 0;">
            <label for="manual-csrf">CSRF Token (csrftoken cookie value):</label><br>
            <input type="text" id="manual-csrf" style="width: 100%; padding: 8px; margin: 5px 0; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid #444;" placeholder="Paste csrftoken value here">
          </div>
          
          <div style="margin: 20px 0;">
            <label for="manual-session">Session Cookie (LEETCODE_SESSION cookie value):</label><br>
            <input type="text" id="manual-session" style="width: 100%; padding: 8px; margin: 5px 0; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid #444;" placeholder="Paste LEETCODE_SESSION value here">
          </div>
          
          <div class="auth-actions">
            <button onclick="saveManualCredentials()" class="btn-primary">Save Credentials</button>
            <button onclick="initializeApp()" class="btn-secondary">Cancel</button>
          </div>
          
          <p class="privacy-note">
            These credentials are stored only in your browser's local storage and are never sent to our servers.
          </p>
        </div>
      `;
    }

    // Function to fetch cookies directly from our server
    async function fetchCookiesFromServer() {
      const loginStatusEl = document.getElementById('loginStatus');

      // Show loading state
      loginStatusEl.innerHTML = `
        <div class="container">
          <div class="pending">
            <div class="spinner"></div>
            <p>Fetching cookies from LeetCode via our server...</p>
            <p><small>Please make sure you're logged into LeetCode in this browser</small></p>
          </div>
        </div>
      `;

      try {
        // Call our server-side endpoint that will fetch cookies for us
        const response = await fetch('http://localhost:5000/api/leetcode/fetch-cookies', {
          method: 'GET',
          headers: {
            'User-Agent': navigator.userAgent
          }
        });

        if (!response.ok) {
          throw new Error(`Server returned ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        console.log('Cookie fetch response:', data);

        if (data.error) {
          throw new Error(data.errorDetails?.message || 'Failed to fetch cookies');
        }

        if (!data.csrfToken || !data.sessionCookie) {
          throw new Error('Could not retrieve required cookies from LeetCode');
        }

        // Automatically fill in the form fields with the retrieved cookies
        document.getElementById('manual-csrf').value = data.csrfToken;
        document.getElementById('manual-session').value = data.sessionCookie;

        // Show success message
        loginStatusEl.innerHTML = `
          <div class="container">
            <div class="success">
              <h3>Cookies Retrieved Successfully!</h3>
              <p>Your LeetCode cookies have been automatically filled in the form below.</p>
              <p>Click "Save Credentials" to continue.</p>
            </div>
            
            <div style="margin: 20px 0;">
              <label for="manual-csrf">CSRF Token (csrftoken cookie value):</label><br>
              <input type="text" id="manual-csrf" value="${data.csrfToken}" style="width: 100%; padding: 8px; margin: 5px 0; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid #444;">
            </div>
            
            <div style="margin: 20px 0;">
              <label for="manual-session">Session Cookie (LEETCODE_SESSION cookie value):</label><br>
              <input type="text" id="manual-session" value="${data.sessionCookie}" style="width: 100%; padding: 8px; margin: 5px 0; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid #444;">
            </div>
            
            <div class="auth-actions">
              <button onclick="saveManualCredentials()" class="btn-primary">Save Credentials</button>
              <button onclick="manualAuthenticationSetup()" class="btn-secondary">Try Again</button>
            </div>
          </div>
        `;

      } catch (error) {
        console.error('Error fetching cookies:', error);

        // Show error and go back to manual form
        loginStatusEl.innerHTML = `
          <div class="container">
            <div class="error">
              <h3>Cookie Fetch Failed</h3>
              <p>${error.message}</p>
              <p>Please try entering your cookies manually instead.</p>
            </div>
            
            <div class="auth-actions" style="margin: 20px 0;">
              <button onclick="manualAuthenticationSetup()" class="btn-primary">Back to Manual Entry</button>
              <button onclick="fetchCookiesFromServer()" class="btn-secondary">Try Again</button>
            </div>
          </div>
        `;
      }
    }

    // Function to save manually entered credentials
    function saveManualCredentials() {
      const csrfToken = document.getElementById('manual-csrf').value.trim();
      const sessionCookie = document.getElementById('manual-session').value.trim();

      if (!csrfToken) {
        alert('Please enter a CSRF token');
        return;
      }

      if (!sessionCookie) {
        alert('Please enter a LEETCODE_SESSION cookie value');
        return;
      }

      // Validate CSRF token format (typically 32+ characters)
      if (csrfToken.length < 32) {
        if (!confirm('The CSRF token looks too short. A typical LeetCode CSRF token is 32+ characters. Do you want to proceed anyway?')) {
          return;
        }
      }

      // Validate session token format
      if (sessionCookie.length < 32) {
        if (!confirm('The LEETCODE_SESSION value looks too short. A typical LeetCode session cookie is very long. Do you want to proceed anyway?')) {
          return;
        }
      }

      // Create manual headers
      const headers = {
        'Content-Type': 'application/json',
        'Cookie': `csrftoken=${csrfToken}; LEETCODE_SESSION=${sessionCookie}`,
        'Referer': 'https://leetcode.com/',
        'User-Agent': navigator.userAgent,
        'x-csrftoken': csrfToken,
        'Origin': 'https://leetcode.com'
      };

      const loginStatusEl = document.getElementById('loginStatus');
      loginStatusEl.innerHTML = `
        <div class="pending">
          <div class="spinner"></div>
          <p>Testing your credentials...</p>
        </div>
      `;

      // Test the credentials before saving
      testCredentials(headers)
        .then(isValid => {
          if (isValid) {
            // Store headers in localStorage
            localStorage.setItem('leetcode_headers', JSON.stringify(headers));

            // Update global headers
            userHeaders = headers;

            loginStatusEl.innerHTML = `
              <div class="success">
                <h3>Credentials Saved Successfully!</h3>
                <p>Your LeetCode credentials have been tested and work correctly.</p>
              </div>
            `;

            // Show the app controls
            document.getElementById('appControls').style.display = 'block';
          } else {
            loginStatusEl.innerHTML = `
              <div class="error">
                <h3>Credentials Test Failed</h3>
                <p>The credentials you entered could not be verified. Please check them and try again.</p>
                <div class="auth-actions">
                  <button onclick="manualAuthenticationSetup()" class="btn-primary">Try Again</button>
                  <button onclick="initializeApp()" class="btn-secondary">Cancel</button>
                </div>
              </div>
            `;
          }
        })
        .catch(error => {
          console.error('Error testing credentials:', error);
          loginStatusEl.innerHTML = `
            <div class="error">
              <h3>Credentials Test Failed</h3>
              <p>Error: ${error.message}</p>
              <div class="auth-actions">
                <button onclick="manualAuthenticationSetup()" class="btn-primary">Try Again</button>
                <button onclick="initializeApp()" class="btn-secondary">Cancel</button>
              </div>
            </div>
          `;
        });
    }

    // Function to test credentials
    async function testCredentials(headers) {
      try {
        console.log('Testing credentials...');

        // Try a direct API call to LeetCode
        const testPayload = {
          headers: headers
        };

        // Call our proxy endpoint to check authentication
        const response = await fetch('http://localhost:5000/api/leetcode/daily', {
          method: 'GET',
          headers: headers
        });

        console.log('Test response status:', response.status);

        if (response.ok) {
          console.log('Credentials test successful!');
          return true;
        } else {
          console.error('Credentials test failed with status:', response.status);
          return false;
        }
      } catch (error) {
        console.error('Error testing credentials:', error);
        throw error;
      }
    }

    // Clear stored credentials
    function clearCredentials() {
      localStorage.removeItem('leetcode_headers');
      userHeaders = null;
      initializeApp();
    }

    async function getDailyChallenge() {
      if (!userHeaders) {
        alert('Please log in to LeetCode first');
        return;
      }

      try {
        document.getElementById('result').innerHTML = `
          <div class="loading-container">
            <div class="spinner"></div>
            <p>Loading today's challenge...</p>
          </div>`;

        const response = await fetch('http://localhost:5000/api/leetcode/daily', {
          headers: userHeaders
        });
        console.log('Response status:', response.status);
        const contentType = response.headers.get('content-type');
        console.log('Content-Type:', contentType);

        const rawText = await response.text();
        console.log('Raw response:', rawText);

        try {
          const data = JSON.parse(rawText);
          questionId = data.questionId;

          // Determine difficulty class
          let difficultyClass = '';
          switch (data.difficulty.toLowerCase()) {
            case 'easy': difficultyClass = 'easy'; break;
            case 'medium': difficultyClass = 'medium'; break;
            case 'hard': difficultyClass = 'hard'; break;
            default: difficultyClass = 'medium';
          }

          // Create HTML content with improved formatting
          const htmlContent = `
            <h2>${data.questionTitle}</h2>
            <div class="challenge-meta">
              <span class="difficulty ${difficultyClass}">${data.difficulty}</span>
              <a href="${data.questionLink}" target="_blank">View on LeetCode</a>
            </div>
            <div class="question-description">${data.question.replace(/\u003C/g, '<').replace(/\u003E/g, '>')}</div>
                `;

          document.getElementById('result').innerHTML = htmlContent;
        } catch (parseError) {
          console.error('JSON Parse Error:', parseError);
          document.getElementById('result').innerHTML = `
            <div class="error">
              <h3>Error Parsing Response</h3>
              <p>${parseError.message}</p>
            </div>`;
        }
      } catch (error) {
        console.error('Fetch Error:', error);
        document.getElementById('result').innerHTML = `
          <div class="error">
            <h3>Error Fetching Challenge</h3>
            <p>${error.message}</p>
          </div>`;
      }
    }

    async function submitSolution() {
      if (!userHeaders) {
        alert('Please log in to LeetCode first');
        return;
      }

      if (!questionId) {
        alert('Please get the daily challenge first!');
        return;
      }

      document.getElementById('submissionStatus').innerHTML = `
        <div class="loading-container">
          <div class="spinner"></div>
          <p>Submitting your solution...</p>
        </div>`;

      const code = document.getElementById('codeInput').value;
      if (!code.trim()) {
        document.getElementById('submissionStatus').innerHTML = `
          <div class="error">
            <h3>Error</h3>
            <p>Please enter your solution code</p>
          </div>`;
        return;
      }

      // Format the code with proper escaped newlines as expected by LeetCode API
      const formattedCode = code.replace(/\r\n/g, '\n').replace(/\n/g, '\n');

      console.log('Original code length:', code.length);
      console.log('Formatted code length:', formattedCode.length);
      console.log('Formatted code sample (first 100 chars):', formattedCode.substring(0, 100));

      const payload = {
        lang: 'cpp',
        question_id: questionId,
        typed_code: formattedCode
      };

      // Create a complete payload with all necessary information
      const completePayload = {
        leetcodePayload: payload,
        headers: userHeaders
      };

      try {
        console.log('Submitting solution with complete payload');

        const response = await fetch('http://localhost:5000/api/leetcode/daily/submit-as-proxy', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(completePayload)
        });
        console.log('Submit response status:', response.status);
        const responseText = await response.text();
        console.log('Raw submit response:', responseText);

        let data;
        try {
          data = JSON.parse(responseText);
          console.log('Parsed submit response:', data);
        } catch (parseError) {
          console.error('Error parsing submit response:', parseError);
          document.getElementById('submissionStatus').innerHTML = `
            <div class="error">
              <h3>Error Parsing Response</h3>
              <p>Server returned invalid JSON</p>
              <details>
                <summary>Show Raw Response</summary>
                <pre>${responseText}</pre>
              </details>
            </div>`;
          return;
        }

        if (data.error) {
          console.error('Error in response:', data.error);
          document.getElementById('submissionStatus').innerHTML = `
            <div class="error">
              <h3>Submission Error</h3>
              <p>${data.error}</p>
            </div>`;
          return;
        }

        if (!data.submission_id) {
          console.error('No submission_id in response:', data);
          document.getElementById('submissionStatus').innerHTML = `
            <div class="error">
              <h3>Invalid Response</h3>
              <p>No submission ID received from server</p>
              <details>
                <summary>Show Server Response</summary>
                <pre>${JSON.stringify(data, null, 2)}</pre>
              </details>
            </div>`;
          return;
        }

        const submissionId = data.submission_id;
        document.getElementById('submissionStatus').innerHTML = `
          <div class="pending">
            <h3>Processing Submission</h3>
            <p>Submission ID: ${submissionId}</p>
            <p>Checking execution status...</p>
          </div>`;
        checkSubmissionStatus(submissionId);
      } catch (error) {
        console.error('Submit solution error:', error);
        document.getElementById('submissionStatus').innerHTML = `
          <div class="error">
            <h3>Submission Failed</h3>
            <p>${error.message}</p>
          </div>`;
      }
    }

    async function checkSubmissionStatus(submissionId) {
      if (!userHeaders) {
        alert('Please log in to LeetCode first');
        return;
      }

      if (!submissionId) {
        console.error('Invalid submission ID:', submissionId);
        document.getElementById('submissionStatus').innerHTML = `
          <div class="error">
            <h3>Error</h3>
            <p>Invalid submission ID</p>
          </div>`;
        return;
      }

      try {
        console.log('Checking submission status for ID:', submissionId);

        // Create a complete headers payload for the status check
        const statusCheckPayload = {
          submissionId: submissionId,
          headers: userHeaders
        };

        const response = await fetch(`http://localhost:5000/api/leetcode/submissions/check-as-proxy`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(statusCheckPayload)
        });

        console.log('Check status response:', response.status);
        const responseText = await response.text();
        console.log('Raw check status response:', responseText);

        let data;
        try {
          data = JSON.parse(responseText);
          console.log('Parsed check status response:', data);
        } catch (parseError) {
          console.error('Error parsing check status response:', parseError);
          document.getElementById('submissionStatus').innerHTML = `
            <div class="error">
              <h3>Error</h3>
              <p>Could not parse status response</p>
            </div>`;
          return;
        }

        // Format the submission status in a more readable way
        let statusHtml = '';

        // If we have a SUCCESS state, create a nicer display
        if (data.state === 'SUCCESS') {
          const resultClass = data.status_msg === 'Accepted' ? 'success' : 'error';
          const percentileFormatted = data.runtime_percentile ? data.runtime_percentile.toFixed(2) : 'N/A';
          const memoryPercentileFormatted = data.memory_percentile ? data.memory_percentile.toFixed(2) : 'N/A';

          statusHtml = `
            <div class="${resultClass}">
              <h3>Submission Result: ${data.status_msg}</h3>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 1rem 0;">
                <div>
                  <h4>Performance</h4>
                  <p><strong>Runtime:</strong> ${data.status_runtime}</p>
                  <p><strong>Memory:</strong> ${data.status_memory}</p>
                </div>
                <div>
                  <h4>Status</h4>
                  <p><strong>Passed:</strong> ${data.total_correct}/${data.total_testcases} tests</p>
                  <p><strong>Status Code:</strong> ${data.status_code}</p>
                </div>
                <div>
                  <h4>Percentiles</h4>
                  <p><strong>Runtime:</strong> ${percentileFormatted}%</p>
                  <p><strong>Memory:</strong> ${memoryPercentileFormatted}%</p>
                </div>
              </div>
            </div>
            <details>
              <summary>Show Full Response</summary>
              <pre>${JSON.stringify(data, null, 2)}</pre>
            </details>
          `;
        } else if (data.state === 'PENDING' || data.state === 'STARTED') {
          // Show a processing message for pending or started submissions
          statusHtml = `
            <div class="pending">
              <h3>Processing Submission...</h3>
              <div style="display: flex; align-items: center; gap: 1rem; margin: 1rem 0;">
                <div class="spinner"></div>
                <div>
                  <p><strong>Status:</strong> ${data.state}</p>
                  <p><strong>Submission ID:</strong> ${submissionId}</p>
                  <p>Checking again in 2 seconds...</p>
                </div>
              </div>
            </div>
            <details>
              <summary>Show Full Response</summary>
              <pre>${JSON.stringify(data, null, 2)}</pre>
            </details>
          `;
        } else {
          // For any other state
          statusHtml = `
            <div class="pending">
              <h3>Status: ${data.state}</h3>
              <p><strong>Submission ID:</strong> ${submissionId}</p>
              ${data.status_msg ? `<p><strong>Message:</strong> ${data.status_msg}</p>` : ''}
            </div>
            <details>
              <summary>Show Full Response</summary>
              <pre>${JSON.stringify(data, null, 2)}</pre>
            </details>
          `;
        }

        document.getElementById('submissionStatus').innerHTML = statusHtml;

        // Check for SUCCESS (uppercase) in the state property and stop polling
        if (data.state === 'SUCCESS') {
          console.log('Submission complete with status:', data.status_msg);
        } else {
          // Continue polling for status if not successful yet
          setTimeout(() => checkSubmissionStatus(submissionId), 2000);
        }
      } catch (error) {
        console.error('Check status error:', error);
        document.getElementById('submissionStatus').innerHTML = `
          <div class="error">
            <h3>Error</h3>
            <p>Failed to check submission status: ${error.message}</p>
          </div>`;
      }
    }

    // Function to switch between tabs
    function switchTab(tabId) {
      // Hide all tab contents
      const tabContents = document.querySelectorAll('.tab-content');
      tabContents.forEach(tab => tab.classList.remove('active'));

      // Deactivate all tab buttons
      const tabButtons = document.querySelectorAll('.tab-button');
      tabButtons.forEach(button => button.classList.remove('active'));

      // Activate the selected tab and its button
      document.getElementById(tabId).classList.add('active');
      document.querySelector(`[onclick="switchTab('${tabId}')"]`).classList.add('active');
    }

    // Function to get problem by slug
    async function getProblemBySlug() {
      if (!userHeaders) {
        alert('Please log in to LeetCode first');
        return;
      }

      const problemSlug = document.getElementById('problemSlug').value.trim();
      if (!problemSlug) {
        alert('Please enter a problem slug or name');
        return;
      }

      try {
        document.getElementById('problemResult').innerHTML = `
          <div class="loading-container">
            <div class="spinner"></div>
            <p>Loading problem details...</p>
          </div>`;

        // Hide the submission section while loading
        document.getElementById('problemSubmitSection').style.display = 'none';

        const response = await fetch(`http://localhost:5000/api/leetcode/problems/${encodeURIComponent(problemSlug)}`, {
          headers: userHeaders
        });

        console.log('Problem fetch response status:', response.status);
        const contentType = response.headers.get('content-type');
        console.log('Content-Type:', contentType);

        const rawText = await response.text();
        console.log('Raw problem response:', rawText.substring(0, 200) + '...');

        try {
          const data = JSON.parse(rawText);

          if (data.error) {
            document.getElementById('problemResult').innerHTML = `
              <div class="error">
                <h3>Error</h3>
                <p>${data.error}</p>
              </div>`;
            return;
          }

          problemQuestionId = data.questionId;
          problemTitleSlug = data.titleSlug; // Store the title slug

          // Determine difficulty class
          let difficultyClass = '';
          switch (data.difficulty.toLowerCase()) {
            case 'easy': difficultyClass = 'easy'; break;
            case 'medium': difficultyClass = 'medium'; break;
            case 'hard': difficultyClass = 'hard'; break;
            default: difficultyClass = 'medium';
          }

          // Create HTML content with improved formatting
          const htmlContent = `
            <h2>${data.questionTitle}</h2>
            <div class="challenge-meta">
              <span class="difficulty ${difficultyClass}">${data.difficulty}</span>
              <a href="${data.questionLink}" target="_blank">View on LeetCode</a>
            </div>
            <div class="question-description">${data.question.replace(/\u003C/g, '<').replace(/\u003E/g, '>')}</div>
          `;

          document.getElementById('problemResult').innerHTML = htmlContent;

          // Show the submission section
          document.getElementById('problemSubmitSection').style.display = 'block';

          // Clear any previous submission status
          document.getElementById('problemSubmissionStatus').innerHTML = '';

          // Clear any previous code input
          document.getElementById('problemCodeInput').value = '';
        } catch (parseError) {
          console.error('JSON Parse Error:', parseError);
          document.getElementById('problemResult').innerHTML = `
            <div class="error">
              <h3>Error Parsing Response</h3>
              <p>${parseError.message}</p>
            </div>`;
        }
      } catch (error) {
        console.error('Fetch Error:', error);
        document.getElementById('problemResult').innerHTML = `
          <div class="error">
            <h3>Error Fetching Problem</h3>
            <p>${error.message}</p>
          </div>`;
      }
    }

    // Function to submit solution for any problem
    async function submitProblemSolution() {
      if (!userHeaders) {
        alert('Please log in to LeetCode first');
        return;
      }

      if (!problemQuestionId) {
        alert('Please get a problem first!');
        return;
      }

      if (!problemTitleSlug) {
        alert('Problem title slug is missing. Please get the problem again.');
        return;
      }

      document.getElementById('problemSubmissionStatus').innerHTML = `
        <div class="loading-container">
          <div class="spinner"></div>
          <p>Submitting your solution...</p>
        </div>`;

      const code = document.getElementById('problemCodeInput').value;
      if (!code.trim()) {
        document.getElementById('problemSubmissionStatus').innerHTML = `
          <div class="error">
            <h3>Error</h3>
            <p>Please enter your solution code</p>
          </div>`;
        return;
      }

      // Format the code with proper escaped newlines as expected by LeetCode API
      const formattedCode = code.replace(/\r\n/g, '\n').replace(/\n/g, '\n');

      console.log('Original code length:', code.length);
      console.log('Formatted code length:', formattedCode.length);
      console.log('Formatted code sample (first 100 chars):', formattedCode.substring(0, 100));

      const payload = {
        lang: 'cpp',
        question_id: problemQuestionId,
        typed_code: formattedCode,
        titleSlug: problemTitleSlug // Add the title slug to the payload
      };

      // Create a complete payload with all necessary information
      const completePayload = {
        leetcodePayload: payload,
        headers: userHeaders
      };

      try {
        console.log('Submitting solution with complete payload');

        const response = await fetch('http://localhost:5000/api/leetcode/problems/submit-as-proxy', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(completePayload)
        });
        console.log('Submit response status:', response.status);
        const responseText = await response.text();
        console.log('Raw submit response:', responseText);

        let data;
        try {
          data = JSON.parse(responseText);
          console.log('Parsed submit response:', data);
        } catch (parseError) {
          console.error('Error parsing submit response:', parseError);
          document.getElementById('problemSubmissionStatus').innerHTML = `
            <div class="error">
              <h3>Error Parsing Response</h3>
              <p>Server returned invalid JSON</p>
              <details>
                <summary>Show Raw Response</summary>
                <pre>${responseText}</pre>
              </details>
            </div>`;
          return;
        }

        if (data.error) {
          console.error('Error in response:', data.error);
          document.getElementById('problemSubmissionStatus').innerHTML = `
            <div class="error">
              <h3>Submission Error</h3>
              <p>${data.error}</p>
            </div>`;
          return;
        }

        if (!data.submission_id) {
          console.error('No submission_id in response:', data);
          document.getElementById('problemSubmissionStatus').innerHTML = `
            <div class="error">
              <h3>Invalid Response</h3>
              <p>No submission ID received from server</p>
              <details>
                <summary>Show Server Response</summary>
                <pre>${JSON.stringify(data, null, 2)}</pre>
              </details>
            </div>`;
          return;
        }

        const submissionId = data.submission_id;
        document.getElementById('problemSubmissionStatus').innerHTML = `
          <div class="pending">
            <h3>Processing Submission</h3>
            <p>Submission ID: ${submissionId}</p>
            <p>Checking execution status...</p>
          </div>`;
        checkProblemSubmissionStatus(submissionId);
      } catch (error) {
        console.error('Submit solution error:', error);
        document.getElementById('problemSubmissionStatus').innerHTML = `
          <div class="error">
            <h3>Submission Failed</h3>
            <p>${error.message}</p>
          </div>`;
      }
    }

    // Function to check submission status for any problem
    async function checkProblemSubmissionStatus(submissionId) {
      if (!userHeaders) {
        alert('Please log in to LeetCode first');
        return;
      }

      if (!submissionId) {
        console.error('Invalid submission ID:', submissionId);
        document.getElementById('problemSubmissionStatus').innerHTML = `
          <div class="error">
            <h3>Error</h3>
            <p>Invalid submission ID</p>
          </div>`;
        return;
      }

      try {
        console.log('Checking submission status for ID:', submissionId);

        // Create a complete headers payload for the status check
        const statusCheckPayload = {
          submissionId: submissionId,
          headers: userHeaders
        };

        const response = await fetch(`http://localhost:5000/api/leetcode/submissions/check-as-proxy`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(statusCheckPayload)
        });

        console.log('Check status response:', response.status);
        const responseText = await response.text();
        console.log('Raw check status response:', responseText);

        let data;
        try {
          data = JSON.parse(responseText);
          console.log('Parsed check status response:', data);
        } catch (parseError) {
          console.error('Error parsing check status response:', parseError);
          document.getElementById('problemSubmissionStatus').innerHTML = `
            <div class="error">
              <h3>Error</h3>
              <p>Could not parse status response</p>
            </div>`;
          return;
        }

        // Format the submission status in a more readable way
        let statusHtml = '';

        // If we have a SUCCESS state, create a nicer display
        if (data.state === 'SUCCESS') {
          const resultClass = data.status_msg === 'Accepted' ? 'success' : 'error';
          const percentileFormatted = data.runtime_percentile ? data.runtime_percentile.toFixed(2) : 'N/A';
          const memoryPercentileFormatted = data.memory_percentile ? data.memory_percentile.toFixed(2) : 'N/A';

          statusHtml = `
            <div class="${resultClass}">
              <h3>Submission Result: ${data.status_msg}</h3>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 1rem 0;">
                <div>
                  <h4>Performance</h4>
                  <p><strong>Runtime:</strong> ${data.status_runtime}</p>
                  <p><strong>Memory:</strong> ${data.status_memory}</p>
                </div>
                <div>
                  <h4>Status</h4>
                  <p><strong>Passed:</strong> ${data.total_correct}/${data.total_testcases} tests</p>
                  <p><strong>Status Code:</strong> ${data.status_code}</p>
                </div>
                <div>
                  <h4>Percentiles</h4>
                  <p><strong>Runtime:</strong> ${percentileFormatted}%</p>
                  <p><strong>Memory:</strong> ${memoryPercentileFormatted}%</p>
                </div>
              </div>
            </div>
            <details>
              <summary>Show Full Response</summary>
              <pre>${JSON.stringify(data, null, 2)}</pre>
            </details>
          `;
        } else if (data.state === 'PENDING' || data.state === 'STARTED') {
          // Show a processing message for pending or started submissions
          statusHtml = `
            <div class="pending">
              <h3>Processing Submission...</h3>
              <div style="display: flex; align-items: center; gap: 1rem; margin: 1rem 0;">
                <div class="spinner"></div>
                <div>
                  <p><strong>Status:</strong> ${data.state}</p>
                  <p><strong>Submission ID:</strong> ${submissionId}</p>
                  <p>Checking again in 2 seconds...</p>
                </div>
              </div>
            </div>
            <details>
              <summary>Show Full Response</summary>
              <pre>${JSON.stringify(data, null, 2)}</pre>
            </details>
          `;
        } else {
          // For any other state
          statusHtml = `
            <div class="pending">
              <h3>Status: ${data.state}</h3>
              <p><strong>Submission ID:</strong> ${submissionId}</p>
              ${data.status_msg ? `<p><strong>Message:</strong> ${data.status_msg}</p>` : ''}
            </div>
            <details>
              <summary>Show Full Response</summary>
              <pre>${JSON.stringify(data, null, 2)}</pre>
            </details>
          `;
        }

        document.getElementById('problemSubmissionStatus').innerHTML = statusHtml;

        // Check for SUCCESS (uppercase) in the state property and stop polling
        if (data.state === 'SUCCESS') {
          console.log('Submission complete with status:', data.status_msg);
        } else {
          // Continue polling for status if not successful yet
          setTimeout(() => checkProblemSubmissionStatus(submissionId), 2000);
        }
      } catch (error) {
        console.error('Check status error:', error);
        document.getElementById('problemSubmissionStatus').innerHTML = `
          <div class="error">
            <h3>Error</h3>
            <p>Failed to check submission status: ${error.message}</p>
          </div>`;
      }
    }

    // Function to switch between tabs
    function switchTab(tabId) {
      // Hide all tab contents
      const tabContents = document.querySelectorAll('.tab-content');
      tabContents.forEach(tab => tab.classList.remove('active'));

      // Deactivate all tab buttons
      const tabButtons = document.querySelectorAll('.tab-button');
      tabButtons.forEach(button => button.classList.remove('active'));

      // Activate the selected tab and its button
      document.getElementById(tabId).classList.add('active');
      document.querySelector(`[onclick="switchTab('${tabId}')"]`).classList.add('active');
    }

    // Function to get problem by slug
    async function getProblemBySlug() {
      if (!userHeaders) {
        alert('Please log in to LeetCode first');
        return;
      }

      const problemSlug = document.getElementById('problemSlug').value.trim();
      if (!problemSlug) {
        alert('Please enter a problem slug or name');
        return;
      }

      try {
        document.getElementById('problemResult').innerHTML = `
          <div class="loading-container">
            <div class="spinner"></div>
            <p>Loading problem details...</p>
          </div>`;

        // Hide the submission section while loading
        document.getElementById('problemSubmitSection').style.display = 'none';

        const response = await fetch(`http://localhost:5000/api/leetcode/problems/${encodeURIComponent(problemSlug)}`, {
          headers: userHeaders
        });

        console.log('Problem fetch response status:', response.status);
        const contentType = response.headers.get('content-type');
        console.log('Content-Type:', contentType);

        const rawText = await response.text();
        console.log('Raw problem response:', rawText.substring(0, 200) + '...');

        try {
          const data = JSON.parse(rawText);

          if (data.error) {
            document.getElementById('problemResult').innerHTML = `
              <div class="error">
                <h3>Error</h3>
                <p>${data.error}</p>
              </div>`;
            return;
          }

          problemQuestionId = data.questionId;
          problemTitleSlug = data.titleSlug; // Store the title slug

          // Determine difficulty class
          let difficultyClass = '';
          switch (data.difficulty.toLowerCase()) {
            case 'easy': difficultyClass = 'easy'; break;
            case 'medium': difficultyClass = 'medium'; break;
            case 'hard': difficultyClass = 'hard'; break;
            default: difficultyClass = 'medium';
          }

          // Create HTML content with improved formatting
          const htmlContent = `
            <h2>${data.questionTitle}</h2>
            <div class="challenge-meta">
              <span class="difficulty ${difficultyClass}">${data.difficulty}</span>
              <a href="${data.questionLink}" target="_blank">View on LeetCode</a>
            </div>
            <div class="question-description">${data.question.replace(/\u003C/g, '<').replace(/\u003E/g, '>')}</div>
          `;

          document.getElementById('problemResult').innerHTML = htmlContent;

          // Show the submission section
          document.getElementById('problemSubmitSection').style.display = 'block';

          // Clear any previous submission status
          document.getElementById('problemSubmissionStatus').innerHTML = '';

          // Clear any previous code input
          document.getElementById('problemCodeInput').value = '';
        } catch (parseError) {
          console.error('JSON Parse Error:', parseError);
          document.getElementById('problemResult').innerHTML = `
            <div class="error">
              <h3>Error Parsing Response</h3>
              <p>${parseError.message}</p>
            </div>`;
        }
      } catch (error) {
        console.error('Fetch Error:', error);
        document.getElementById('problemResult').innerHTML = `
          <div class="error">
            <h3>Error Fetching Problem</h3>
            <p>${error.message}</p>
          </div>`;
      }
    }

    // Function to submit solution for any problem
    async function submitProblemSolution() {
      if (!userHeaders) {
        alert('Please log in to LeetCode first');
        return;
      }

      if (!problemQuestionId) {
        alert('Please get a problem first!');
        return;
      }

      if (!problemTitleSlug) {
        alert('Problem title slug is missing. Please get the problem again.');
        return;
      }

      document.getElementById('problemSubmissionStatus').innerHTML = `
        <div class="loading-container">
          <div class="spinner"></div>
          <p>Submitting your solution...</p>
        </div>`;

      const code = document.getElementById('problemCodeInput').value;
      if (!code.trim()) {
        document.getElementById('problemSubmissionStatus').innerHTML = `
          <div class="error">
            <h3>Error</h3>
            <p>Please enter your solution code</p>
          </div>`;
        return;
      }

      // Format the code with proper escaped newlines as expected by LeetCode API
      const formattedCode = code.replace(/\r\n/g, '\n').replace(/\n/g, '\n');

      console.log('Original code length:', code.length);
      console.log('Formatted code length:', formattedCode.length);
      console.log('Formatted code sample (first 100 chars):', formattedCode.substring(0, 100));

      const payload = {
        lang: 'cpp',
        question_id: problemQuestionId,
        typed_code: formattedCode,
        titleSlug: problemTitleSlug // Add the title slug to the payload
      };

      // Create a complete payload with all necessary information
      const completePayload = {
        leetcodePayload: payload,
        headers: userHeaders
      };

      try {
        console.log('Submitting solution with complete payload');

        const response = await fetch('http://localhost:5000/api/leetcode/problems/submit-as-proxy', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(completePayload)
        });
        console.log('Submit response status:', response.status);
        const responseText = await response.text();
        console.log('Raw submit response:', responseText);

        let data;
        try {
          data = JSON.parse(responseText);
          console.log('Parsed submit response:', data);
        } catch (parseError) {
          console.error('Error parsing submit response:', parseError);
          document.getElementById('problemSubmissionStatus').innerHTML = `
            <div class="error">
              <h3>Error Parsing Response</h3>
              <p>Server returned invalid JSON</p>
              <details>
                <summary>Show Raw Response</summary>
                <pre>${responseText}</pre>
              </details>
            </div>`;
          return;
        }

        if (data.error) {
          console.error('Error in response:', data.error);
          document.getElementById('problemSubmissionStatus').innerHTML = `
            <div class="error">
              <h3>Submission Error</h3>
              <p>${data.error}</p>
            </div>`;
          return;
        }

        if (!data.submission_id) {
          console.error('No submission_id in response:', data);
          document.getElementById('problemSubmissionStatus').innerHTML = `
            <div class="error">
              <h3>Invalid Response</h3>
              <p>No submission ID received from server</p>
              <details>
                <summary>Show Server Response</summary>
                <pre>${JSON.stringify(data, null, 2)}</pre>
              </details>
            </div>`;
          return;
        }

        const submissionId = data.submission_id;
        document.getElementById('problemSubmissionStatus').innerHTML = `
          <div class="pending">
            <h3>Processing Submission</h3>
            <p>Submission ID: ${submissionId}</p>
            <p>Checking execution status...</p>
          </div>`;
        checkProblemSubmissionStatus(submissionId);
      } catch (error) {
        console.error('Submit solution error:', error);
        document.getElementById('problemSubmissionStatus').innerHTML = `
          <div class="error">
            <h3>Submission Failed</h3>
            <p>${error.message}</p>
          </div>`;
      }
    }

    // Function to check submission status for any problem
    async function checkProblemSubmissionStatus(submissionId) {
      if (!userHeaders) {
        alert('Please log in to LeetCode first');
        return;
      }

      if (!submissionId) {
        console.error('Invalid submission ID:', submissionId);
        document.getElementById('problemSubmissionStatus').innerHTML = `
          <div class="error">
            <h3>Error</h3>
            <p>Invalid submission ID</p>
          </div>`;
        return;
      }

      try {
        console.log('Checking submission status for ID:', submissionId);

        // Create a complete headers payload for the status check
        const statusCheckPayload = {
          submissionId: submissionId,
          headers: userHeaders
        };

        const response = await fetch(`http://localhost:5000/api/leetcode/submissions/check-as-proxy`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(statusCheckPayload)
        });

        console.log('Check status response:', response.status);
        const responseText = await response.text();
        console.log('Raw check status response:', responseText);

        let data;
        try {
          data = JSON.parse(responseText);
          console.log('Parsed check status response:', data);
        } catch (parseError) {
          console.error('Error parsing check status response:', parseError);
          document.getElementById('problemSubmissionStatus').innerHTML = `
            <div class="error">
              <h3>Error</h3>
              <p>Could not parse status response</p>
            </div>`;
          return;
        }

        // Format the submission status in a more readable way
        let statusHtml = '';

        // If we have a SUCCESS state, create a nicer display
        if (data.state === 'SUCCESS') {
          const resultClass = data.status_msg === 'Accepted' ? 'success' : 'error';
          const percentileFormatted = data.runtime_percentile ? data.runtime_percentile.toFixed(2) : 'N/A';
          const memoryPercentileFormatted = data.memory_percentile ? data.memory_percentile.toFixed(2) : 'N/A';

          statusHtml = `
            <div class="${resultClass}">
              <h3>Submission Result: ${data.status_msg}</h3>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 1rem 0;">
                <div>
                  <h4>Performance</h4>
                  <p><strong>Runtime:</strong> ${data.status_runtime}</p>
                  <p><strong>Memory:</strong> ${data.status_memory}</p>
                </div>
                <div>
                  <h4>Status</h4>
                  <p><strong>Passed:</strong> ${data.total_correct}/${data.total_testcases} tests</p>
                  <p><strong>Status Code:</strong> ${data.status_code}</p>
                </div>
                <div>
                  <h4>Percentiles</h4>
                  <p><strong>Runtime:</strong> ${percentileFormatted}%</p>
                  <p><strong>Memory:</strong> ${memoryPercentileFormatted}%</p>
                </div>
              </div>
            </div>
            <details>
              <summary>Show Full Response</summary>
              <pre>${JSON.stringify(data, null, 2)}</pre>
            </details>
          `;
        } else if (data.state === 'PENDING' || data.state === 'STARTED') {
          // Show a processing message for pending or started submissions
          statusHtml = `
            <div class="pending">
              <h3>Processing Submission...</h3>
              <div style="display: flex; align-items: center; gap: 1rem; margin: 1rem 0;">
                <div class="spinner"></div>
                <div>
                  <p><strong>Status:</strong> ${data.state}</p>
                  <p><strong>Submission ID:</strong> ${submissionId}</p>
                  <p>Checking again in 2 seconds...</p>
                </div>
              </div>
            </div>
            <details>
              <summary>Show Full Response</summary>
              <pre>${JSON.stringify(data, null, 2)}</pre>
            </details>
          `;
        } else {
          // For any other state
          statusHtml = `
            <div class="pending">
              <h3>Status: ${data.state}</h3>
              <p><strong>Submission ID:</strong> ${submissionId}</p>
              ${data.status_msg ? `<p><strong>Message:</strong> ${data.status_msg}</p>` : ''}
            </div>
            <details>
              <summary>Show Full Response</summary>
              <pre>${JSON.stringify(data, null, 2)}</pre>
            </details>
          `;
        }

        document.getElementById('problemSubmissionStatus').innerHTML = statusHtml;

        // Check for SUCCESS (uppercase) in the state property and stop polling
        if (data.state === 'SUCCESS') {
          console.log('Submission complete with status:', data.status_msg);
        } else {
          // Continue polling for status if not successful yet
          setTimeout(() => checkProblemSubmissionStatus(submissionId), 2000);
        }
      } catch (error) {
        console.error('Check status error:', error);
        document.getElementById('problemSubmissionStatus').innerHTML = `
          <div class="error">
            <h3>Error</h3>
            <p>Failed to check submission status: ${error.message}</p>
          </div>`;
      }
    }

    // Initialize the app when the page loads
    document.addEventListener('DOMContentLoaded', initializeApp);
  </script>
</body>

</html>